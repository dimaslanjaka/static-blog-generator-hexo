name: Build Site

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**/*.tgz'
      - '**/*.gz'
      - '**/release/**'
      - '.github/codeql/*'
      - '**codeql**'
      - '**clean-caches**'
  workflow_dispatch:

concurrency:
  # group: build-${{ github.event.push.number || github.event.pull_request.number || github.ref }}
  group: deploy
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: read-all
    timeout-minutes: 120
    strategy:
      fail-fast: false
    env:
      NODE_OPTIONS: "--max_old_space_size=8192" #8192 4096 --expose-gc
      YARN_ENABLE_IMMUTABLE_INSTALLS: false

    steps:
      - run: git config --global core.autocrlf false
      - uses: actions/checkout@v3
        with:
          ref: master
          repository: dimaslanjaka/static-blog-generator-hexo
          submodules: recursive
          token: "${{ secrets.ACCESS_TOKEN }}"
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          architecture: x64
          cache: 'yarn'
          check-latest: true
      - run: |
          corepack prepare yarn@3.2.0 --activate
          corepack enable
      - run: npm i -g npm-run-all lerna nx gulp-cli hexo-cli typescript ts-node depcheck husky
      - run: yarn install
      - run: |
          echo "node_modules/.bin" >> $GITHUB_PATH
          echo "bin" >> $GITHUB_PATH
        name: register bin
      - run: yarn workspace sbg-utility build
      - run: yarn workspace sbg-api build
      - run: yarn workspace sbg-server build
      - run: yarn workspace sbg-cli build
      - run: yarn workspace static-blog-generator build
      - run: yarn workspace chimeraland build
      - run: yarn workspace chimeraland build
      - run: npm rebuild
      - run: which sbg
      - run: npx sbg post standalone
      - run: npx sbg post copy
      - run: hexo generate
      - run: gulp deploy:copy
      - run: npx sbg deploy seo
      - run: npx sbg deploy safelink
      - name: Deploy ðŸš€
        #if: ${{ false }}
        #if: steps.push-manual.outcome == 'failure' && steps.push-manual.conclusion == 'failure'
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          #commit-message: "update: commit ${{ env.GITHUB_COMMIT_URL }} runner ${{ env.GITHUB_RUNNER_URL }}"
          branch: 'master' # The branch the action should deploy to.
          folder: "." # The folder the action should deploy.
          force: false # merge instead push --force, (keep old / non modified) files?
          token: "${{ secrets.ACCESS_TOKEN }}" # github token
          repository-name: "dimaslanjaka/static-blog-generator-hexo" # Repostory URL
          git-config-email: 'dimaslanjaka@gmail.com'
          git-config-name: 'dimaslanjaka'
          clean-exclude: "*"
